<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="../stylesheets/codemirror.css" rel="stylesheet">
    <link href="../stylesheets/alicestyle.css" rel="stylesheet">
    <link href="../stylesheets/common.css" rel="stylesheet">
    <title>事件系统 - Extag</title>
  </head>
  <body>
    <aside class="side-bar"></aside>
    <div class="main">
      <article class="article">
        <h2>事件系统</h2>
        <p>
          事件系统是Extag的基础，Watcher对象提供的实例方法，实现了监听、移除和派发任意类型事件的功能。
          Extag中Element、Component等类的原型都混入了这些事件方法，并且进一步实现了转接转发DOM事件的功能。
          组件还会派发生命周期事件和属性更改事件，数据绑定功能也正依赖此。
        </p>
        <h3 id="on-off-emit">on, off, emit</h3>
        <p>用<span class="expr">on</span>方法来监听指定类型的事件，用<span class="expr">off</span>方法来移除相应类型的事件处理函数，用<span class="expr">emit</span>方法来派发事件，向事件处理函数传递附带参数。用例如下：</p>
        <div class="code-box scroll"><div class="CodeMirror cm-s-alice"><div class="CodeMirror-code" ><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">watcher</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Extag</span>.<span class="cm-property">Watcher</span>();</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-comment">// 单个监听</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">on</span>(<span class="cm-string">'click'</span>, <span class="cm-keyword">function</span>(<span class="cm-def">event</span>) {</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">  <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-number">0</span>, <span class="cm-variable-2">event</span>.<span class="cm-property">type</span>);</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">onPoint</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>, <span class="cm-def">z</span>) {</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">  <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable-2">x</span>, <span class="cm-variable-2">y</span>, <span class="cm-variable-2">z</span>);</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-comment">// 多个监听</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">wtacher</span>.<span class="cm-property">on</span>({</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">  <span class="cm-property">point</span>: <span class="cm-variable">onPoint</span>,</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">  <span class="cm-property">click</span>: <span class="cm-keyword">function</span>(<span class="cm-def">event</span>) {</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">    <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-number">1</span>, <span class="cm-variable-2">event</span>.<span class="cm-property">type</span>);</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">  <span class="cm-property">ready</span>: [<span class="cm-keyword">function</span>() {}, {<span class="cm-property">once</span>: <span class="cm-atom">true</span>}]  <span class="cm-comment">// 单次监听, on('ready', func, {once: true})</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">emit</span>(<span class="cm-string">'point'</span>, <span class="cm-number">0</span>, <span class="cm-number">1</span>, <span class="cm-number">2</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// 触发onPoint，输出: 0 1 2</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">emit</span>(<span class="cm-string">'click'</span>, {<span class="cm-property">type</span>:<span class="cm-string">'click'</span>});  <span class="cm-comment">// 模拟转发click事件，输出: 0 click</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;">                                        <span class="cm-comment">//                   输出: 1 click</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">off</span>(<span class="cm-string">'point'</span>, <span class="cm-variable">onPoint</span>);        <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 移除了point事件处理函数onPoint</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">off</span>(<span class="cm-string">'click'</span>);                   <span class="cm-comment">// 移除了所有click事件处理函数</span></span></pre><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">off</span>();                          <span class="cm-comment">// 移除了所有类型事件处理函数</span></span></pre></div></div></div>
        <div  class="tip-box"><p>在Extag内部，对于Element、Component等，我们使用<span class="expr">on</span>方法监听DOM事件，是间接调用<span class="expr">addEventListener</span>方法实现的，<span class="expr">off</span>方法同理。我们使用<span class="expr">emit</span>方法转发DOM事件（作为<span class="expr">emit</span>方法的第二个参数），相应处理函数接受到的第一个参数就是Event对象。</p></div>
        <p>对于DOM事件，默认监听的是冒泡阶段的事件。如果要监听捕获阶段的事件，可以这样：</p>
        <div class="code-box scroll"><div class="CodeMirror cm-s-alice"><div class="CodeMirror-code"><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">on</span>(<span class="cm-string">'click'</span>, <span class="cm-keyword">function</span>() {}, {<span class="cm-property">capture</span>: <span class="cm-atom">true</span>});</span></pre></div></div></div>
        <p>如果浏览器addEventListener方法支持<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#Parameters" target="_blank" class="link">passive</a>选项，则可以这样：</p>
        <div class="code-box scroll"><div class="CodeMirror cm-s-alice"><div class="CodeMirror-code"><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">on</span>(<span class="cm-string">'click'</span>, <span class="cm-keyword">function</span>() {}, {<span class="cm-property">passive</span>: <span class="cm-atom">true</span>});</span></pre></div></div></div>
        <p>对于只会派发一次的事件，或只需触发一次的事件处理函数，可以这样：</p><div class="code-box scroll"><div class="CodeMirror cm-s-alice"><div class="CodeMirror-code"><pre class=" CodeMirror-line "><span style="padding-right: 0.1px;"><span class="cm-variable">watcher</span>.<span class="cm-property">on</span>(<span class="cm-string">'ready'</span>, <span class="cm-keyword">function</span>() {}, {<span class="cm-property">once</span>: <span class="cm-atom">true</span>});</span></pre></div></div></div>
      </article>
      <footer>
        <p>Copyright © 2017-2021 Enjolras Chen</p>
      </footer>
    </div>
    <script src="../javascripts/extag-dom.min.js"></script>
    <script src="../javascripts/extag.min.js"></script>
    <script src="../javascripts/common.js"></script>
  </body>
</html>